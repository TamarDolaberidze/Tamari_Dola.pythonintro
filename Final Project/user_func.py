import json
from datetime import datetime
from user_auth import *
from parking_payment import *

parking_data_file = "parkingZones.json"
User_auth = "users.json"

class UserFunctions:
    def __init__(self, user_id):
        self.user_id = user_id #áƒ áƒáƒªáƒ áƒ˜áƒ£áƒ–áƒ”áƒ áƒ˜ log in-áƒ¡ áƒáƒ™áƒ”áƒ—áƒ”áƒ‘áƒ¡, user_id áƒ’áƒáƒ“áƒáƒ”áƒªáƒ”áƒ›áƒ
        self.user_menu()
    
    def user_menu(self): 
        #áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒšáƒ˜áƒ¡ áƒ›áƒ”áƒœáƒ˜áƒ£, áƒ—áƒ£ áƒ£áƒœáƒ“áƒ áƒ›áƒáƒœáƒ¥áƒáƒœáƒ˜áƒ¡ áƒ“áƒáƒ áƒ”áƒ’áƒ˜áƒ¡áƒ¢áƒ áƒ˜áƒ áƒ”áƒ‘áƒ áƒáƒ áƒáƒáƒ¥áƒ¢áƒ˜áƒ£áƒ  áƒáƒáƒ áƒ™áƒ˜áƒœáƒ’áƒ˜áƒ¡ áƒ–áƒáƒœáƒáƒ¨áƒ˜
        while True:
            print("\n--- User Menu ---")
            print("1. Find Available Zone and Register Car in Parking Zone")
            print("2. Remove your car from the parking zone")
            print("3. Check your balance")
            print("4. Leave Account")


            choice = input("Choose an option: ")
            if choice == "1":
                self.register_car_in_zone()  #áƒ›áƒáƒœáƒ¥áƒáƒœáƒ˜áƒ¡ áƒ“áƒáƒ¡áƒáƒ áƒ”áƒ’áƒ˜áƒ¡áƒ¢áƒ áƒ˜áƒ áƒ”áƒ‘áƒšáƒáƒ“ áƒ›áƒ”áƒ—áƒáƒ“áƒ˜áƒ¡ áƒ’áƒáƒ›áƒáƒ«áƒáƒ®áƒ”áƒ‘áƒ
            elif choice == "2": 
                self.remove_car_from_zone() #áƒ›áƒáƒœáƒ¥áƒáƒœáƒ˜áƒ¡ áƒáƒáƒ áƒ™áƒ˜áƒœáƒ’áƒ˜áƒ“áƒáƒœ áƒ¬áƒáƒ¨áƒšáƒ˜áƒ¡ áƒ›áƒ”áƒ—áƒáƒ“áƒ˜áƒ¡ áƒ’áƒáƒ›áƒáƒ«áƒáƒ®áƒ”áƒ‘áƒ
            elif choice == "3":
                self.check_balance() #áƒ˜áƒ£áƒ–áƒ”áƒ áƒ˜áƒ¡ áƒ‘áƒáƒšáƒáƒœáƒ¡áƒ˜áƒ¡ áƒ¨áƒ”áƒ›áƒáƒ¬áƒ›áƒ”áƒ‘áƒ˜áƒ¡ áƒ›áƒ”áƒ—áƒáƒ“áƒ˜áƒ¡ áƒ’áƒáƒ›áƒáƒ«áƒáƒ®áƒ”áƒ‘áƒ
            elif choice == "4":
                print("ğŸ‘‹ Exiting User Menu.")
                break  
            else:
                print("âŒ Invalid choice. Please try again.")
                      
    def load_parking_zones(self):
        #áƒ›áƒ”áƒ—áƒáƒ“áƒ˜ áƒ–áƒáƒœáƒ”áƒ‘áƒ˜áƒ¡ áƒ¡áƒ˜áƒáƒ“ áƒ“áƒáƒ¡áƒáƒ‘áƒ áƒ£áƒœáƒ”áƒ‘áƒšáƒáƒ“
        try:
            with open(parking_data_file, "r") as file:
                data = json.load(file)
                return data.get("parking_zones", []) #áƒáƒ‘áƒ áƒ£áƒœáƒ”áƒ‘áƒ¡ áƒ§áƒ•áƒ”áƒšáƒ áƒ–áƒáƒœáƒáƒ¡ áƒ—áƒáƒ•áƒ˜áƒ¡áƒ˜ áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ”áƒ‘áƒ˜áƒ—, áƒ¡áƒ˜áƒáƒ“
            
        except (FileNotFoundError, json.JSONDecodeError):
            print("âŒ Error: Parking zones data not found.")
            return None
    
    def list_available_zones(self):
        #áƒ›áƒ”áƒ—áƒáƒ“áƒ˜ áƒáƒ‘áƒ áƒ£áƒœáƒ”áƒ‘áƒ¡ áƒ–áƒáƒœáƒ”áƒ‘áƒ¡, áƒ áƒáƒ›áƒšáƒ”áƒ‘áƒ˜áƒª áƒáƒ¥áƒ¢áƒ˜áƒ£áƒ áƒ˜ áƒáƒ áƒáƒ
        parking_zones = self.load_parking_zones()
        if not parking_zones:
            return 
        
        #áƒ®áƒ”áƒšáƒ›áƒ˜áƒ¡áƒáƒ¬áƒ•áƒ“áƒáƒ›áƒ˜ áƒáƒœáƒ£ áƒáƒ áƒáƒáƒ¥áƒ¢áƒ˜áƒ£áƒ áƒ˜ áƒ¡áƒáƒáƒáƒ áƒ™áƒ˜áƒœáƒ’áƒ áƒ–áƒáƒœáƒ”áƒ‘áƒ˜áƒ¡ áƒ¡áƒ˜áƒ
        available_zones = [zone for zone in parking_zones if not any(entry['status'] == 'active' for entry in zone['history'])]

        #áƒ®áƒ”áƒšáƒ›áƒ˜áƒ¡áƒáƒ¬áƒ•áƒ“áƒáƒ›áƒ˜ áƒ–áƒáƒœáƒ”áƒ‘áƒ˜áƒ¡ áƒ“áƒáƒáƒ áƒ˜áƒœáƒ¢áƒ•áƒ áƒ˜áƒœáƒ“áƒ”áƒ¥áƒ¡áƒ˜áƒ—
        if available_zones:
            print("\nğŸš— Available Parking Zones:")
            index = 1
            for zone in available_zones:
                print(f"{index}. {zone['name']} (Address: {zone['address']}, Price: {zone['price']}$)")
                index += 1
            return available_zones
        else:
            print("âŒ No available parking zones.")
            return None
    
    def save_parking_zones(self, parking_zones): #áƒáƒáƒ áƒ™áƒ˜áƒœáƒ’áƒ˜áƒ¡ áƒ–áƒáƒœáƒ”áƒ‘áƒ˜áƒ¡ áƒ¨áƒ”áƒ¡áƒáƒœáƒáƒ®áƒáƒ“. áƒ áƒáƒªáƒ áƒ¡áƒáƒ­áƒ˜áƒ áƒ áƒ˜áƒ¥áƒœáƒ”áƒ‘áƒ áƒ’áƒáƒ›áƒáƒ•áƒ˜áƒ«áƒáƒ®áƒ”áƒ‘áƒ—
        try:
            with open(parking_data_file, 'w') as file:
                json.dump({"parking_zones": parking_zones}, file, indent=4)
        except Exception as e:
            print(f"âŒ Error saving parking zones: {e}")
    
    def register_car_in_zone(self): 
        #áƒ›áƒ”áƒ—áƒáƒ“áƒ˜ áƒ–áƒáƒœáƒáƒ¨áƒ˜ áƒ›áƒáƒœáƒ¥áƒáƒœáƒ˜áƒ¡ áƒ“áƒáƒ¡áƒáƒ áƒ”áƒ’áƒ˜áƒ¡áƒ¢áƒ áƒ˜áƒ áƒ”áƒ‘áƒšáƒáƒ“

        #áƒ®áƒ”áƒšáƒ›áƒ˜áƒ¡áƒáƒ¬áƒ•áƒ“áƒáƒ›áƒ˜ áƒáƒáƒ áƒ™áƒ˜áƒ áƒ”áƒ‘áƒ˜áƒ¡ áƒ–áƒáƒœáƒ”áƒ‘áƒ˜áƒ¡ áƒ’áƒáƒ¨áƒ•áƒ”áƒ‘áƒ
        available_zones = self.list_available_zones()
        #áƒ—áƒ£ áƒ–áƒáƒœáƒ”áƒ‘áƒ˜ áƒáƒ  áƒáƒ áƒ˜áƒ¡ áƒ®áƒ”áƒšáƒ›áƒ˜áƒ¡áƒáƒ¬áƒ•áƒ“áƒáƒ›áƒ˜
        if not available_zones:
            return
        
        try:
            #áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ”áƒšáƒ›áƒ áƒáƒ˜áƒ áƒ©áƒ˜áƒáƒ¡ áƒ áƒ˜áƒ’áƒ˜áƒ—áƒ˜ áƒœáƒáƒ›áƒ áƒ”áƒ‘áƒ˜ áƒ˜áƒ› áƒ–áƒáƒœáƒ”áƒ‘áƒ˜áƒ¡, áƒ¡áƒáƒ“áƒáƒª áƒ“áƒáƒáƒáƒ áƒ™áƒ˜áƒœáƒ’áƒ”áƒ‘áƒ áƒ£áƒœáƒ“áƒ (áƒáƒœ áƒ”áƒ áƒ—áƒ˜ áƒ–áƒáƒœáƒ˜áƒ¡). áƒ’áƒáƒ›áƒáƒ§áƒáƒ¡ áƒ›áƒ«áƒ˜áƒ›áƒ˜áƒ— áƒáƒœ áƒ¡áƒ¤áƒ”áƒ˜áƒ¡áƒ˜áƒ—
            zone_choices = input("\nEnter the sequence number of the zones you want to park (separate by spaces or commas): ")

            #áƒ¥áƒ›áƒœáƒ˜áƒ¡ áƒ¡áƒ˜áƒáƒ¡, áƒ áƒáƒ›áƒ”áƒšáƒ˜áƒª áƒáƒ áƒ©áƒ”áƒ£áƒšáƒ˜ áƒ áƒ˜áƒ’áƒ˜áƒ¡ áƒœáƒáƒ›áƒ áƒ”áƒ‘áƒ¡ áƒ§áƒ•áƒ”áƒšáƒáƒ¡ áƒáƒ¥áƒªáƒ”áƒ•áƒ¡ áƒ˜áƒœáƒ¢áƒ”áƒ¯áƒ”áƒ áƒáƒ“ áƒ“áƒ áƒáƒ™áƒšáƒ”áƒ‘áƒ¡ áƒ”áƒ áƒ—áƒ¡ (áƒ áƒáƒ“áƒ’áƒáƒœáƒáƒª áƒ®áƒ”áƒšáƒ›áƒ˜áƒ¡áƒáƒ¬áƒ•áƒ“áƒáƒ›áƒ˜ áƒáƒáƒ áƒ™áƒ˜áƒ áƒ”áƒ‘áƒ˜áƒ¡ áƒ¡áƒ˜áƒáƒ¨áƒ˜ áƒáƒ˜áƒ áƒ•áƒ”áƒšáƒ˜ áƒ”áƒšáƒ”áƒ›áƒ”áƒœáƒ¢áƒ˜ 0 áƒ˜áƒœáƒ“áƒ”áƒ¥áƒ¡áƒ–áƒ”áƒ)
            selected_indexes = [int(num) - 1 for num in zone_choices.replace(",", " ").split()]

            #áƒ•áƒáƒ›áƒáƒ¬áƒ›áƒ”áƒ‘áƒ— áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒšáƒ˜áƒ¡ áƒ›áƒ˜áƒ”áƒ  áƒáƒ áƒ©áƒ”áƒ£áƒšáƒ˜ áƒœáƒáƒ›áƒ”áƒ áƒ˜ áƒ—áƒ£ áƒáƒ áƒ˜áƒ¡ áƒ•áƒáƒšáƒ˜áƒ“áƒ£áƒ  áƒ áƒ”áƒ˜áƒœáƒ¯áƒ¨áƒ˜
            if any(index < 0 or index >= len(available_zones) for index in selected_indexes):
                print("âŒ Invalid choice. Please select from the list.")
                return #áƒ›áƒ”áƒ—áƒáƒ“áƒ˜áƒ¡ áƒ“áƒáƒ¥áƒ”áƒœáƒ¡áƒ”áƒšáƒ”áƒ‘áƒ, áƒ—áƒ£ áƒáƒ áƒáƒ•áƒáƒšáƒ˜áƒ“áƒ£áƒ áƒ˜ áƒáƒ áƒ©áƒ”áƒ•áƒáƒœáƒ˜áƒ
            
            for index in selected_indexes:

            #áƒ—áƒ£ áƒ•áƒáƒšáƒ˜áƒ“áƒ£áƒ áƒ˜ áƒáƒ áƒ©áƒ”áƒ•áƒáƒœáƒ˜áƒ, áƒ®áƒ”áƒšáƒ›áƒ˜áƒ¡áƒáƒ¬áƒ•áƒ“áƒáƒ›áƒ˜ áƒ–áƒáƒœáƒ”áƒ‘áƒ˜áƒ“áƒáƒœ selected_zone-áƒ¡ áƒ•áƒáƒœáƒ˜áƒ­áƒ”áƒ‘áƒ— áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒšáƒ˜áƒ¡ áƒ›áƒ˜áƒ”áƒ  áƒáƒ áƒ©áƒ”áƒ£áƒš áƒ–áƒáƒœáƒáƒ¡
                selected_zone = available_zones[index]

                #áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ”áƒšáƒ¡ áƒ•áƒ—áƒ®áƒáƒ•áƒ— áƒ›áƒáƒœáƒ¥áƒáƒœáƒ˜áƒ¡ áƒœáƒáƒ›áƒ áƒ˜áƒ¡ áƒ¨áƒ”áƒ§áƒ•áƒáƒœáƒáƒ¡
                license_plate = input("Enter your car's license plate: ")

                #áƒáƒ®áƒšáƒáƒœáƒ“áƒ”áƒš áƒ“áƒ áƒáƒ¡ áƒ•áƒ£áƒ—áƒ˜áƒ—áƒ”áƒ‘áƒ— áƒ¡áƒáƒ¬áƒ§áƒ˜áƒ¡ áƒ“áƒ áƒáƒ“
                start_time = datetime.now()

                #áƒ•áƒ¥áƒ›áƒœáƒ˜áƒ— áƒáƒ®áƒáƒš áƒ”áƒšáƒ”áƒ›áƒ”áƒœáƒ¢áƒ¡ áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒšáƒ˜áƒ¡ áƒ›áƒ˜áƒ”áƒ  áƒáƒ áƒ©áƒ”áƒ£áƒš áƒ–áƒáƒœáƒáƒ¨áƒ˜ áƒ“áƒáƒ¡áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒšáƒáƒ“
                new_entry = {
                    "license_plate": license_plate,
                    "start_time": start_time.strftime("%Y-%m-%d %H:%M:%S"),
                    "Owner_id": self.user_id, 
                    "end_time": "",
                    "status": "active"}

                #áƒ’áƒáƒ•áƒ£áƒ¨áƒáƒ— áƒáƒ®áƒšáƒáƒœáƒ“áƒ”áƒšáƒ˜ áƒ–áƒáƒœáƒ”áƒ‘áƒ˜ áƒ¯áƒ¡áƒáƒœ áƒ¤áƒáƒ˜áƒšáƒ˜áƒ“áƒáƒœ
                parking_zones = self.load_parking_zones() 

                #áƒ—áƒ£ áƒáƒ  áƒ”áƒ¨áƒ•áƒ”áƒ‘áƒ áƒ¤áƒáƒ˜áƒšáƒ˜, áƒ•áƒáƒ¥áƒ”áƒœáƒ¡áƒ”áƒšáƒ”áƒ‘áƒ— áƒ›áƒ”áƒ—áƒáƒ“áƒ¡
                if parking_zones is None:
                    return

                #áƒáƒáƒ áƒ™áƒ˜áƒ áƒ”áƒ‘áƒ˜áƒ¡ áƒ–áƒáƒœáƒ”áƒ‘áƒ˜áƒ¡ áƒ¯áƒ¡áƒáƒœ áƒ¤áƒáƒ˜áƒšáƒ¨áƒ˜ áƒªáƒ˜áƒ™áƒšáƒ˜áƒ— áƒ›áƒ˜áƒ•áƒ§áƒ•áƒ”áƒ‘áƒ˜áƒ— áƒ—áƒ˜áƒ—áƒáƒ”áƒ£áƒš áƒ–áƒáƒœáƒáƒ¡, áƒ áƒáƒ—áƒ áƒ•áƒ˜áƒáƒáƒ•áƒáƒ— áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒšáƒ˜áƒ¡ áƒ›áƒ˜áƒ”áƒ  áƒáƒ áƒ©áƒ”áƒ£áƒšáƒ˜ áƒ–áƒáƒœáƒ
                for zone in parking_zones:
                    if zone["name"] == selected_zone["name"]:
                        zone["history"].append(new_entry) #áƒ“áƒáƒ•áƒáƒ›áƒáƒ¢áƒáƒ— áƒáƒ®áƒáƒšáƒ˜ áƒ”áƒšáƒ”áƒ›áƒ”áƒœáƒ¢áƒ˜ 
                        break #áƒ¡áƒ¬áƒáƒ  áƒ–áƒáƒœáƒáƒ¡ áƒ áƒáƒªáƒ áƒ•áƒ˜áƒáƒáƒ•áƒ˜áƒ—, áƒ’áƒáƒ•áƒáƒ©áƒ”áƒ áƒáƒ— áƒªáƒ˜áƒ™áƒšáƒ˜
                
                self.save_parking_zones(parking_zones) #áƒ¨áƒ”áƒ•áƒ˜áƒœáƒáƒ®áƒáƒ— áƒ“áƒáƒáƒ¤áƒ“áƒ”áƒ˜áƒ—áƒ‘áƒ£áƒšáƒ˜ áƒáƒáƒ áƒ™áƒ˜áƒœáƒ’áƒ˜áƒ¡ áƒ–áƒáƒœáƒ”áƒ‘áƒ˜ áƒ¯áƒ¡áƒáƒœ áƒ¤áƒáƒ˜áƒšáƒ¨áƒ˜

                #áƒ•áƒáƒªáƒœáƒáƒ‘áƒáƒ— áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ”áƒšáƒ¡, áƒ áƒáƒ› áƒ›áƒ˜áƒ¡áƒ˜ áƒ›áƒáƒœáƒ¥áƒáƒœáƒ áƒ¬áƒáƒ áƒ›áƒáƒ¢áƒ”áƒ‘áƒ˜áƒ— áƒ“áƒáƒ áƒ”áƒ’áƒ˜áƒ¡áƒ¢áƒ áƒ˜áƒ áƒ“áƒ áƒ–áƒáƒœáƒáƒ¨áƒ˜
                print(f"âœ… Car registered successfully in {selected_zone['name']}.")

        except ValueError: #áƒ áƒáƒªáƒ áƒáƒ áƒáƒ•áƒáƒšáƒ˜áƒ“áƒ£áƒ  choice number-áƒ¡ áƒ¨áƒ”áƒ˜áƒ§áƒ•áƒáƒœáƒ¡ áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ”áƒšáƒ˜
                print("âŒ Please enter a valid number.")

    def remove_car_from_zone(self):
        #áƒ›áƒ”áƒ—áƒáƒ“áƒ˜ áƒ¨áƒ”áƒ¡áƒáƒ‘áƒáƒ›áƒ˜áƒ¡áƒ˜ áƒáƒáƒ áƒ™áƒ˜áƒœáƒ’áƒ˜áƒ¡ áƒ–áƒáƒœáƒ˜áƒ“áƒáƒœ áƒ›áƒáƒœáƒ¥áƒáƒœáƒ˜áƒ¡ áƒ¬áƒáƒ¡áƒáƒ¨áƒšáƒ”áƒšáƒáƒ“
        parking_zones = self.load_parking_zones()

        if not parking_zones:
            return

        #áƒ•áƒ¥áƒ›áƒœáƒ˜áƒ— áƒ¯áƒ”áƒ  áƒªáƒáƒ áƒ˜áƒ”áƒš áƒ¡áƒ˜áƒáƒ¡, áƒ áƒáƒ›áƒ”áƒšáƒ¨áƒ˜áƒª áƒ©áƒáƒ”áƒ¬áƒ”áƒ áƒ”áƒ‘áƒ áƒ˜áƒ£áƒ–áƒ”áƒ˜áƒ áƒ˜áƒ¡ áƒáƒ˜áƒ“áƒ˜áƒ¡ áƒ¨áƒ”áƒ¡áƒáƒ‘áƒáƒ›áƒ˜áƒ¡áƒ˜ áƒ–áƒáƒœáƒ áƒ“áƒ áƒ–áƒáƒœáƒ˜áƒ¡ áƒ”áƒšáƒ”áƒ›áƒ”áƒœáƒ¢áƒ˜, áƒ áƒáƒ›áƒ”áƒšáƒ˜áƒ¡ áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜áƒª áƒáƒ¥áƒ¢áƒ˜áƒ£áƒ áƒ˜áƒ
        user_parking_history = []
        for zone in parking_zones:
            for entry in zone['history']:
                if entry.get('Owner_id') == self.user_id and entry.get('status') == 'active': #get áƒ›áƒ”áƒ—áƒáƒ“áƒ˜, áƒ áƒáƒ—áƒ áƒ›áƒ˜áƒ•áƒ¬áƒ•áƒ“áƒ”áƒ— áƒšáƒ”áƒ¥áƒ¡áƒ˜áƒ™áƒáƒœáƒ˜áƒ¡ key-áƒ¡ 
                    user_parking_history.append((zone, entry))

        if not user_parking_history:
            print("âŒ You don't have any active parking reservations.")
            return

        #áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ”áƒšáƒ¡ áƒ©áƒáƒ›áƒáƒ•áƒ£áƒ¬áƒ”áƒ áƒ— áƒáƒ¥áƒ¢áƒ˜áƒ£áƒ  áƒ–áƒáƒœáƒ”áƒ‘áƒ¡, áƒ áƒáƒ›áƒšáƒ”áƒ‘áƒ¨áƒ˜áƒª áƒ›áƒáƒ—áƒ˜ áƒ›áƒáƒœáƒ¥áƒáƒœáƒáƒ áƒ“áƒáƒáƒáƒ áƒ™áƒ˜áƒœáƒ’áƒ”áƒ‘áƒ£áƒšáƒ˜, áƒ–áƒáƒœáƒáƒ¡ áƒ—áƒáƒœ áƒ›áƒáƒ§áƒ•áƒ”áƒ‘áƒ áƒ›áƒáƒœáƒ¥áƒáƒœáƒ˜áƒ¡ áƒœáƒáƒ›áƒ”áƒ áƒ˜, áƒ“áƒáƒ¬áƒ§áƒ”áƒ‘áƒ˜áƒ¡áƒ áƒ“áƒ áƒ“áƒáƒ¡áƒ áƒ£áƒšáƒ”áƒ‘áƒ˜áƒ¡ áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜
        print("\nğŸš— Your active parking zones:")
        index = 1
        for zone, entry in user_parking_history:
            print(f"{index}. {zone['name']} (License Plate: {entry['license_plate']}, Start Time: {entry['start_time']}, End Time: {entry['end_time']})")
            index += 1

        try:
            #áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ”áƒšáƒ¡ áƒ•áƒ—áƒ®áƒáƒ•áƒ— áƒ©áƒáƒ›áƒáƒ—áƒ•áƒšáƒ˜áƒšáƒ˜ áƒ–áƒáƒœáƒ”áƒ‘áƒ˜áƒ“áƒáƒœ áƒáƒ˜áƒ áƒ©áƒ˜áƒáƒ¡ áƒ–áƒáƒœáƒ”áƒ‘áƒ˜áƒ¡ áƒ áƒ˜áƒ’áƒ˜áƒ—áƒ˜ áƒœáƒáƒ›áƒ áƒ”áƒ‘áƒ˜, áƒ áƒáƒ›áƒšáƒ”áƒ‘áƒ˜áƒ“áƒáƒœáƒáƒª áƒ£áƒœáƒ“áƒ áƒ›áƒáƒœáƒ¥áƒáƒœáƒ˜áƒ¡ áƒ¬áƒáƒ¨áƒšáƒ (áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜áƒ¡ áƒ¨áƒ”áƒªáƒ•áƒšáƒ)
            zone_choices = input("\nEnter the sequence numbers of the zones to remove your car from (separate by spaces or commas): ")
            #áƒ¥áƒ›áƒœáƒ˜áƒ¡ áƒ¡áƒ˜áƒáƒ¡, áƒ áƒáƒ›áƒ”áƒšáƒ˜áƒª áƒáƒ áƒ©áƒ”áƒ£áƒšáƒ˜ áƒ áƒ˜áƒ’áƒ˜áƒ¡ áƒœáƒáƒ›áƒ áƒ”áƒ‘áƒ¡ áƒáƒ¥áƒªáƒ”áƒ•áƒ¡ áƒ˜áƒœáƒ¢áƒ”áƒ¯áƒ”áƒ áƒáƒ“ áƒ“áƒ áƒ§áƒ•áƒ”áƒšáƒáƒ¡ áƒáƒ™áƒšáƒ”áƒ‘áƒ¡ áƒ”áƒ áƒ—áƒ¡ (áƒ áƒáƒ“áƒ’áƒáƒœáƒáƒª user_parking_history áƒ¡áƒ˜áƒáƒ¨áƒ˜ áƒáƒ˜áƒ áƒ•áƒ”áƒšáƒ˜ áƒ”áƒšáƒ”áƒ›áƒ”áƒœáƒ¢áƒ˜ 0 áƒ˜áƒœáƒ“áƒ”áƒ¥áƒ¡áƒ–áƒ”áƒ)
            selected_indexes = [int(choice.strip()) - 1 for choice in zone_choices.replace(",", " ").split()]

            #áƒ•áƒáƒ›áƒáƒ¬áƒ›áƒ”áƒ‘áƒ— áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒšáƒ˜áƒ¡ áƒ›áƒ˜áƒ”áƒ  áƒáƒ áƒ©áƒ”áƒ£áƒšáƒ˜ áƒœáƒáƒ›áƒ”áƒ áƒ˜ áƒ—áƒ£ áƒáƒ áƒ˜áƒ¡ áƒ•áƒáƒšáƒ˜áƒ“áƒ£áƒ  áƒ áƒ”áƒ˜áƒœáƒ¯áƒ¨áƒ˜
            if any(index < 0 or index >= len(user_parking_history) for index in selected_indexes):
                print("âŒ Invalid selection.")
                return

            # áƒ˜áƒ¢áƒ”áƒ áƒáƒªáƒ˜áƒ selected_index áƒ¡áƒ˜áƒáƒ–áƒ” áƒ“áƒ áƒ›áƒáƒœáƒ¥áƒáƒœáƒ˜áƒ¡ áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜áƒ¡ áƒ¨áƒ”áƒªáƒ•áƒšáƒ "expired"-áƒ–áƒ”
            for selected_choice in selected_indexes:
                #user_paking_history áƒáƒ áƒ˜áƒ¡ tuple-áƒ”áƒ‘áƒ˜áƒ¡áƒ’áƒáƒœ áƒ¨áƒ”áƒ›áƒ“áƒ’áƒáƒ áƒ˜ áƒ¡áƒ˜áƒ, áƒ®áƒ“áƒ”áƒ‘áƒ áƒ–áƒáƒœáƒ˜áƒ¡áƒ áƒ“áƒ áƒ–áƒáƒœáƒ˜áƒ¡ tuple áƒ”áƒšáƒ”áƒ›áƒ”áƒœáƒ¢áƒ”áƒ‘áƒ˜áƒ¡ unpacking
                zone_choices, selected_entry = user_parking_history[selected_choice]
                
                #end_time-áƒ˜áƒ¡ áƒ“áƒáƒ§áƒ”áƒœáƒ”áƒ‘áƒ áƒ–áƒáƒœáƒ˜áƒ¡ áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ¨áƒ”áƒ¡áƒáƒªáƒ•áƒšáƒ”áƒš áƒ”áƒšáƒ”áƒ›áƒ”áƒœáƒ¢áƒ–áƒ”
                selected_entry['end_time'] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

                #áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜áƒ¡ áƒªáƒ•áƒšáƒ˜áƒšáƒ”áƒ‘áƒ "expired-áƒ–áƒ”"
                selected_entry['status'] = 'expired'
                
                #áƒáƒáƒ áƒ™áƒ˜áƒœáƒ’áƒ˜áƒ¡ áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ˜áƒ¡ áƒ¤áƒ£áƒœáƒ¥áƒªáƒ˜áƒ˜áƒ¡ áƒ›áƒ”áƒ—áƒáƒ“áƒ˜áƒ¡ áƒ’áƒáƒ›áƒáƒ«áƒáƒ®áƒ”áƒ‘áƒ, áƒ áƒáƒ—áƒ áƒ“áƒáƒ˜áƒ©áƒáƒ áƒ¯áƒáƒ¡ áƒ“áƒ áƒ“áƒáƒáƒ¤áƒ“áƒ”áƒ˜áƒ—áƒ“áƒ”áƒ¡ áƒ‘áƒáƒšáƒáƒœáƒ¡áƒ˜
                print(f"Processing payment for car with license plate {selected_entry['license_plate']}...")
                ParkingPayment.parking_payment(self.user_id, selected_entry['license_plate'])


            # áƒ¨áƒ”áƒ˜áƒœáƒáƒ®áƒ” áƒ“áƒáƒáƒ¤áƒ“áƒ”áƒ˜áƒ—áƒ‘áƒ£áƒšáƒ˜ áƒ¡áƒáƒáƒáƒ áƒ™áƒ˜áƒœáƒ’áƒ” áƒ–áƒáƒœáƒ”áƒ‘áƒ˜ áƒáƒœ áƒ–áƒáƒœáƒ˜áƒ“áƒáƒœ
            self.save_parking_zones(parking_zones)

            # áƒ“áƒáƒáƒ™áƒáƒœáƒ¤áƒ˜áƒ áƒ›áƒ” áƒ›áƒáƒœáƒ¥áƒáƒœáƒ˜áƒ¡ áƒ¬áƒáƒ¨áƒšáƒ áƒ¡áƒáƒáƒáƒ áƒ™áƒ˜áƒœáƒ’áƒ” áƒ–áƒáƒœáƒ”áƒ‘áƒ˜áƒ“áƒáƒœ áƒáƒœ áƒ–áƒáƒœáƒ˜áƒ“áƒáƒœ
            print(f"âœ… Selected cars removed from the parking zones.")

        except ValueError:
            print("âŒ Please enter valid numbers.")
    
    def check_balance(self):
        #áƒ›áƒ”áƒ—áƒáƒ“áƒ˜, áƒ áƒáƒ›áƒ”áƒšáƒ˜áƒª áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ”áƒšáƒ¡ áƒ¨áƒ”áƒáƒ›áƒáƒ¬áƒ›áƒ”áƒ‘áƒ˜áƒœáƒ”áƒ‘áƒ¡ áƒ‘áƒáƒšáƒáƒœáƒ¡áƒ¡ áƒ“áƒ áƒ’áƒáƒ›áƒáƒ£áƒ—áƒ•áƒšáƒ˜áƒ¡ áƒ áƒáƒ›áƒ“áƒ”áƒœáƒ˜ áƒáƒ¥áƒ•áƒ¡ áƒ’áƒáƒ“áƒáƒ¡áƒáƒ®áƒ“áƒ”áƒšáƒ˜
 
        try:
            with open (User_auth, "r") as file:
                users = json.load(file)

                #áƒ•áƒ˜áƒáƒáƒ•áƒáƒ— áƒ˜áƒ£áƒ–áƒ”áƒ áƒ˜ áƒ›áƒ˜áƒ¡áƒ˜ áƒáƒ˜áƒ“áƒ˜áƒ—
                user = next((user for user in users if user["user_id"] == self.user_id), None)

                if user:
                  #áƒ®áƒ”áƒšáƒ›áƒ˜áƒ¡áƒáƒ¬áƒ•áƒ“áƒáƒ›áƒ˜ áƒ–áƒáƒœáƒ”áƒ‘áƒ˜áƒ¡ (áƒ¡áƒáƒ“áƒáƒª áƒ˜áƒ£áƒ–áƒ”áƒ áƒ˜áƒ¡ áƒáƒ¥áƒ¢áƒ˜áƒ£áƒ áƒ˜ áƒ›áƒáƒœáƒ¥áƒáƒœáƒáƒ) áƒ’áƒáƒ¡áƒáƒ¨áƒ•áƒ”áƒ‘áƒáƒ“ áƒ›áƒ”áƒ—áƒáƒ“áƒ˜áƒ¡ áƒ’áƒáƒ›áƒáƒ«áƒáƒ®áƒ”áƒ‘áƒ
                    parking_zones = self.load_parking_zones()
                if not parking_zones:
                    return

                total_fee = 0 #áƒ–áƒáƒœáƒ”áƒ‘áƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡/áƒ–áƒáƒœáƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡ áƒ›áƒ—áƒšáƒ˜áƒáƒœáƒ˜ áƒ’áƒáƒ“áƒáƒ¡áƒáƒ®áƒáƒ“áƒ˜áƒ¡ áƒ˜áƒœáƒªáƒ˜áƒáƒšáƒ˜áƒ–áƒ”áƒ‘áƒ
                active_cars_fees = [] #áƒ¡áƒ˜áƒ áƒ—áƒ˜áƒ—áƒáƒ”áƒ£áƒšáƒ˜ áƒáƒ¥áƒ¢áƒ˜áƒ£áƒ áƒ˜ áƒ›áƒáƒœáƒ¥áƒáƒœáƒ˜áƒ¡ áƒ’áƒáƒ“áƒáƒ¡áƒáƒ®áƒáƒ“áƒ˜áƒ¡ áƒ¨áƒ”áƒ¡áƒáƒœáƒáƒ®áƒáƒ“

                #áƒ¡áƒáƒ‘áƒáƒšáƒáƒ áƒ˜áƒœáƒ¤áƒáƒ áƒ›áƒáƒªáƒ˜áƒ˜áƒ¡ áƒ’áƒáƒ›áƒáƒ¢áƒáƒœáƒ áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒšáƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡
                print(f"Your current balance is {user['balance']} $.") #áƒáƒ®áƒšáƒáƒœáƒ“áƒ”áƒšáƒ˜ áƒ‘áƒáƒšáƒáƒœáƒ¡áƒ˜áƒ¡ áƒ©áƒ•áƒ”áƒœáƒ”áƒ‘áƒ

                #áƒ˜áƒ¢áƒ”áƒ áƒáƒªáƒ˜áƒ áƒáƒáƒ áƒ™áƒ˜áƒœáƒ’áƒ˜áƒ¡ áƒ–áƒáƒœáƒ”áƒ‘áƒ–áƒ”, áƒ áƒáƒ—áƒ áƒáƒ¥áƒ¢áƒ˜áƒ£áƒ áƒ˜ entry-áƒ¡áƒ—áƒ•áƒ˜áƒ¡ áƒ’áƒáƒ›áƒáƒ•áƒ˜áƒ—áƒ•áƒáƒšáƒáƒ— áƒ›áƒ—áƒšáƒ˜áƒáƒœáƒ˜ áƒ’áƒáƒ“áƒáƒ¡áƒáƒ®áƒáƒ“áƒ˜
                for zone in parking_zones:
                    for entry in zone['history']:
                        if entry.get('Owner_id') == self.user_id and entry.get('status') == 'active':
                            
                            #start_time-áƒ˜áƒ¡ áƒ¡áƒ¢áƒ áƒ˜áƒœáƒ’áƒ¡ áƒ•áƒáƒáƒ áƒ¡áƒáƒ•áƒ— áƒ“áƒ áƒ•áƒáƒ¥áƒªáƒ”áƒ•áƒ— datetime áƒáƒ‘áƒ˜áƒ”áƒ¥áƒ¢áƒáƒ“
                            start_time = datetime.strptime(entry["start_time"], "%Y-%m-%d %H:%M:%S")

                            end_time = datetime.now()  #áƒáƒ®áƒšáƒáƒœáƒ“áƒ”áƒšáƒ˜ áƒ“áƒ áƒ áƒ®áƒ“áƒ”áƒ‘áƒ end_time
                            
                            duration = (end_time - start_time).total_seconds() / 3600  #áƒáƒáƒ áƒ™áƒ˜áƒœáƒ’áƒ˜áƒ¡ áƒ®áƒáƒœáƒ’áƒ áƒ«áƒšáƒ˜áƒ•áƒáƒ‘áƒ áƒ¡áƒáƒáƒ—áƒ”áƒ‘áƒ¨áƒ˜
                            
                            zone_fee = duration * zone["price"] #áƒ’áƒáƒ“áƒáƒ¡áƒáƒ®áƒáƒ“áƒ˜áƒ¡ áƒ’áƒáƒ›áƒáƒ—áƒ•áƒšáƒ áƒ–áƒáƒœáƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡

                            total_fee += zone_fee #áƒ§áƒ•áƒ”áƒšáƒ áƒ–áƒáƒœáƒ”áƒ‘áƒ˜áƒ¡/áƒ–áƒáƒœáƒ˜áƒ¡ áƒ’áƒáƒ“áƒáƒ¡áƒáƒ®áƒáƒ“áƒ˜áƒ¡ áƒ’áƒáƒ›áƒáƒ—áƒ•áƒšáƒ

                            active_cars_fees.append({
                                'license_plate': entry['license_plate'],
                                'zone_name': zone['name'],
                                'fee': zone_fee
                            }) #áƒáƒ¥áƒ¢áƒ˜áƒ£áƒ áƒ˜ áƒ›áƒáƒœáƒ¥áƒáƒœáƒ”áƒ‘áƒ˜áƒ¡ áƒ’áƒáƒ“áƒáƒ¡áƒáƒ®áƒáƒ“áƒ˜áƒ¡ áƒ–áƒ”áƒ›áƒáƒ— áƒ˜áƒœáƒ˜áƒªáƒ˜áƒáƒšáƒ˜áƒ–áƒ”áƒ‘áƒ£áƒš áƒšáƒ˜áƒ¡áƒ—áƒ¡ áƒ•áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ— áƒ’áƒáƒ“áƒáƒ¡áƒáƒ®áƒáƒ“áƒ˜áƒ¡ áƒ¨áƒ”áƒ¡áƒáƒ®áƒ”áƒ‘ áƒ˜áƒœáƒ¤áƒáƒ áƒ›áƒáƒªáƒ˜áƒáƒ¡ áƒ—áƒ˜áƒ—áƒáƒ”áƒ£áƒšáƒ˜ áƒ–áƒáƒœáƒ˜áƒ¡áƒ áƒ“áƒ áƒ›áƒáƒœáƒ¥áƒáƒœáƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡ (áƒ—áƒ£ áƒ”áƒ áƒ—áƒ–áƒ” áƒ›áƒ”áƒ¢áƒ˜ áƒáƒ¡áƒ”áƒ—áƒ˜ áƒ›áƒáƒ¥áƒáƒœáƒáƒ, áƒ”áƒ áƒ—áƒ–áƒ” áƒ›áƒ”áƒ¢áƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡)


                if active_cars_fees:
                    print(f"\nTotal amount to pay for active parking sessions: {total_fee:.2f} $.") #áƒ¡áƒáƒ”áƒ áƒ—áƒ áƒ’áƒáƒ“áƒáƒ¡áƒáƒ®áƒáƒ“áƒ˜áƒ¡ áƒ©áƒ•áƒ”áƒœáƒ”áƒ‘áƒ áƒ§áƒ•áƒ”áƒšáƒ áƒ–áƒáƒœáƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡/áƒ”áƒ áƒ—áƒ˜ áƒ–áƒáƒœáƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡

                    print("\nPayment details for active parking sessions:")
                    for car in active_cars_fees:
                        print(f"  - Car {car['license_plate']} in {car['zone_name']}: {car['fee']:.2f} $") #áƒ—áƒ˜áƒ—áƒáƒ”áƒ£áƒšáƒ˜ áƒ–áƒáƒœáƒ˜áƒ¡, áƒ›áƒáƒœáƒ¥áƒáƒœáƒ˜áƒ¡áƒ áƒ“áƒ áƒ’áƒáƒ“áƒáƒ¡áƒáƒ®áƒáƒ“áƒ˜áƒ¡ áƒ˜áƒœáƒ¤áƒáƒ áƒ›áƒáƒªáƒ˜áƒ˜áƒ¡ áƒ’áƒáƒ›áƒáƒ¢áƒáƒœáƒ
                else:
                    print("âŒ You don't have any active parking sessions.")
    
        except Exception as e:
            print(f"âŒ Error checking balance: {e}")